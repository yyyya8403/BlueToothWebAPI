<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nearby Bluetooth Scanner (Web Bluetooth)</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 24px; }
  .row { margin: 10px 0; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  label { font-size: 14px; color: #333; }
  input, button, select { padding: 8px 12px; border: 1px solid #ccc; border-radius: 10px; }
  button{ cursor: pointer; }
  #log { white-space: pre-wrap; background:#f7f7f7; padding:12px; border-radius:8px; min-height: 90px; }
  table { border-collapse: collapse; width: 100%; margin-top: 12px; }
  th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; }
  th { background: #fafafa; position: sticky; top: 0; }
  .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; background:#eef; }
</style>
</head>
<body>
<h1>è¿‘ãã®Bluetoothæ©Ÿå™¨ã‚’æ¢ã™</h1>

<div class="row">
  <label>åå‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹:</label>
  <input id="namePrefix" placeholder='ä¾‹: "ESP", "micro:bit"' />
  <label>Service UUID / æ¨™æº–å:</label>
  <input id="serviceUuid" placeholder='ä¾‹: 0x180f / battery_serviceï¼ˆä»»æ„ï¼‰' />
</div>

<div class="row">
  <button id="btnStart">ğŸ” ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
  <button id="btnStop" disabled>ğŸ›‘ åœæ­¢</button>
  <span id="mode" class="badge">æº–å‚™ä¸­</span>
</div>

<div id="log"></div>

<table>
  <thead>
    <tr>
      <th>åå‰</th>
      <th>ãƒ‡ãƒã‚¤ã‚¹ID</th>
      <th>RSSI</th>
      <th>TxPower</th>
      <th>Service UUIDs</th>
      <th>æœ€çµ‚æ¤œå‡º</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const log = (msg) => { $('log').textContent += msg + '\n'; };
  const modeBadge = $('mode');
  const tbody = $('tbody');

  let scan = null;                  // BluetoothLEScan (requestLEScan ã®æˆ»ã‚Šå€¤)
  let scanning = false;
  const devices = new Map();        // id -> {name, id, rssi, txPower, uuids, lastSeen}

  function normalizeUuid(v) {
    const s = (v || '').trim().toLowerCase();
    if (!s) return '';
    if (/^0x[0-9a-f]{4}$/.test(s)) return s; // 16bit alias
    if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/.test(s)) return s; // 128bit
    // æ¨™æº–åï¼ˆbattery_service ç­‰ï¼‰ã¯ãã®ã¾ã¾è¿”ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å´ãŒè§£é‡ˆï¼‰
    return s;
  }

  function fmtTime(d) {
    return new Date(d).toLocaleTimeString();
  }

  function render() {
    // æ–°ã—ã„é †ï¼ˆlastSeenï¼‰ã‹ã¤ RSSI å¼·ã„é †ã§è¡¨ç¤º
    const rows = Array.from(devices.values())
      .sort((a, b) => (b.lastSeen - a.lastSeen) || (b.rssi ?? -999) - (a.rssi ?? -999))
      .map(dev => {
        const uuids = (dev.uuids && dev.uuids.length) ? dev.uuids.join(', ') : '';
        return `<tr>
          <td>${escapeHtml(dev.name || '(no name)')}</td>
          <td>${escapeHtml(dev.id || '')}</td>
          <td>${dev.rssi ?? ''}</td>
          <td>${dev.txPower ?? ''}</td>
          <td style="max-width:360px;overflow-wrap:anywhere;">${escapeHtml(uuids)}</td>
          <td>${fmtTime(dev.lastSeen)}</td>
        </tr>`;
      }).join('');
    tbody.innerHTML = rows;
  }

  function escapeHtml(s) {
    return (s ?? '').toString()
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  function updateMode(text) {
    modeBadge.textContent = text;
  }

  async function startScan() {
    if (!('bluetooth' in navigator)) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Web Bluetooth ã«æœªå¯¾å¿œã§ã™ã€‚Chrome/Edge ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
      return;
    }

    $('btnStart').disabled = true;
    $('btnStop').disabled = false;
    devices.clear(); render(); $('log').textContent = '';

    const namePrefix = $('namePrefix').value.trim();
    const service = normalizeUuid($('serviceUuid').value);

    // --- A) æœ¬å‘½: requestLEScan ãŒä½¿ãˆã‚‹å ´åˆï¼ˆãƒ©ã‚¤ãƒ–ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
    if ('requestLEScan' in navigator.bluetooth) {
      try {
        const options = {
          // acceptAllAdvertisements ã‹ filters ã®ã©ã¡ã‚‰ã‹ãŒå¿…è¦
          acceptAllAdvertisements: !namePrefix && !service,
          keepRepeatedDevices: true
        };
        const filters = [];
        if (namePrefix) filters.push({ namePrefix });
        if (service)    filters.push({ services: [service] });
        if (filters.length) options.filters = filters;

        log('ğŸ“¡ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ï¼ˆrequestLEScanï¼‰...');
        scan = await navigator.bluetooth.requestLEScan(options);
        scanning = true;
        updateMode('ã‚¹ã‚­ãƒ£ãƒ³ä¸­ï¼ˆLE Scanï¼‰');

        navigator.bluetooth.addEventListener('advertisementreceived', onAdvReceived);
      } catch (e) {
        log('âŒ requestLEScan å¤±æ•—: ' + e);
        // B ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        await fallbackChooser();
      }
      return;
    }

    // --- B) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«1å°é¸ã‚“ã§ã‚‚ã‚‰ã„ã€åºƒå‘Šå—ä¿¡ã‚’ç›£è¦–
    await fallbackChooser();
  }

  async function fallbackChooser() {
    try {
      updateMode('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆChooserï¼‰');
      const namePrefix = $('namePrefix').value.trim();
      const service = normalizeUuid($('serviceUuid').value);

      const filters = [];
      if (namePrefix) filters.push({ namePrefix });
      const options = filters.length
        ? { filters, optionalServices: service ? [service] : [] }
        : { acceptAllDevices: true, optionalServices: service ? [service] : [] };

      log('ğŸ“¥ ãƒ‡ãƒã‚¤ã‚¹é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã™...');
      const device = await navigator.bluetooth.requestDevice(options);

      // ä¸€è¦§ã«1ä»¶è¿½åŠ 
      addOrUpdateDevice({
        name: device.name,
        id: device.id,
        rssi: null,
        txPower: null,
        uuids: device.uuids || [],
        lastSeen: Date.now()
      });
      render();

      // å¯èƒ½ãªã‚‰åºƒå‘Šå—ä¿¡ã‚’ç›£è¦–ï¼ˆå¯¾å¿œã—ã¦ã„ãªã„ãƒ‡ãƒã‚¤ã‚¹ã‚‚ã‚ã‚Šã¾ã™ï¼‰
      if ('watchAdvertisements' in device) {
        log('ğŸ‘‚ åºƒå‘Šå—ä¿¡ã‚’å¾…æ©Ÿã—ã¾ã™ï¼ˆwatchAdvertisementsï¼‰...');
        device.addEventListener('advertisementreceived', onAdvReceived);
        await device.watchAdvertisements();
        scanning = true;
      } else {
        log('â„¹ï¸ ã“ã®ç’°å¢ƒ/ãƒ‡ãƒã‚¤ã‚¹ã¯ watchAdvertisements ã«æœªå¯¾å¿œã®ã‚ˆã†ã§ã™ã€‚');
      }
    } catch (e) {
      log('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯å¤±æ•—: ' + e);
      stopScan(true);
    }
  }

  function onAdvReceived(ev) {
    try {
      // ev ã¯ `BluetoothAdvertisingEvent`ï¼ˆrequestLEScanï¼‰ã‹ã€device ã® advertisementreceivedï¼ˆwatchAdvertisementsï¼‰
      const d = ev.device || ev.target || {};
      const id = d.id || '(unknown)';
      const entry = {
        name: d.name || '(no name)',
        id,
        rssi: ev.rssi ?? null,
        txPower: ev.txPower ?? null,
        uuids: (ev.uuids && ev.uuids.length ? ev.uuids : (d.uuids || [])) || [],
        lastSeen: Date.now()
      };
      addOrUpdateDevice(entry);
      render();
    } catch (e) {
      log('âŒ å—ä¿¡å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + e);
    }
  }

  function addOrUpdateDevice(info) {
    const cur = devices.get(info.id);
    if (!cur) {
      devices.set(info.id, info);
    } else {
      Object.assign(cur, info);
    }
  }

  function stopScan(silent = false) {
    if (scan) {
      try { scan.stop(); } catch {}
      scan = null;
    }
    scanning = false;
    $('btnStart').disabled = false;
    $('btnStop').disabled = true;
    updateMode('åœæ­¢ä¸­');
    if (!silent) log('ğŸ›‘ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢');
  }

  // UI
  $('btnStart').addEventListener('click', async () => {
    try {
      await startScan();
    } catch (e) {
      log('âŒ ' + e);
      stopScan(true);
    }
  });
  $('btnStop').addEventListener('click', () => stopScan());

  // åˆæœŸè¡¨ç¤º
  updateMode('å¾…æ©Ÿä¸­');
})();
</script>
</body>
</html>
