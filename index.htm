<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Web Bluetooth Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; margin: 6px 8px 6px 0; }
    input { padding: 8px; width: 260px; }
    #log { white-space: pre-wrap; background:#f7f7f7; padding:12px; border-radius:8px; min-height: 140px; }
    .row { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Web Bluetooth: æ¢ã™â†’æ¥ç¶šâ†’æ“ä½œ</h1>

  <div class="row">
    <label>Service UUIDï¼ˆä¾‹: 0x180F = Battery Serviceï¼‰</label><br/>
    <input id="serviceUuid" value="0x180F" />
  </div>

  <div class="row">
    <label>Characteristic UUIDï¼ˆä¾‹: 0x2A19 = Battery Levelï¼‰</label><br/>
    <input id="charUuid" value="0x2A19" />
  </div>

  <div class="row">
    <label>åå‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆä»»æ„ã€‚ä¾‹: "ESP", "BBC micro:bit" ãªã©ï¼‰</label><br/>
    <input id="namePrefix" placeholder="ç©ºãªã‚‰å…¨ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰é¸æŠï¼ˆæ¥ç¶šæ™‚ã«Serviceã‚’è¦æ±‚ï¼‰" />
  </div>

  <div class="row">
    <button id="btnScan">ğŸ” æ¢ã—ã¦æ¥ç¶š</button>
    <button id="btnDisconnect" disabled>ğŸ”Œ åˆ‡æ–­</button>
  </div>

  <div class="row">
    <button id="btnRead" disabled>ğŸ“¥ Read</button>
    <button id="btnWrite" disabled>ğŸ“¤ Write(0x01)</button>
    <button id="btnNotifyStart" disabled>ğŸ”” Start Notify</button>
    <button id="btnNotifyStop" disabled>ğŸ”• Stop Notify</button>
  </div>

  <h3>Log</h3>
  <div id="log"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const log = (msg) => { $('log').textContent += msg + '\n'; };

  let device = null;
  let server = null;
  let characteristic = null;

  const uiState = (connected) => {
    $('btnDisconnect').disabled   = !connected;
    $('btnRead').disabled         = !connected;
    $('btnWrite').disabled        = !connected;
    $('btnNotifyStart').disabled  = !connected;
    $('btnNotifyStop').disabled   = !connected;
    $('btnScan').disabled         = connected;
  };

  async function scanAndConnect() {
    try {
      const serviceUuid = $('serviceUuid').value.trim();
      const charUuid = $('charUuid').value.trim();
      const namePrefix = $('namePrefix').value.trim();

      if (!serviceUuid) {
        alert('Service UUID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ä¾‹: 0x180F');
        return;
      }

      const filters = [];
      if (namePrefix) filters.push({ namePrefix });

      // ãƒ‡ãƒã‚¤ã‚¹é¸æŠ: ãƒ•ã‚£ãƒ«ã‚¿ãŒç„¡ã„å ´åˆã¯ acceptAllDevices: true
      const options = filters.length
        ? { filters, optionalServices: [serviceUuid] }
        : { acceptAllDevices: true, optionalServices: [serviceUuid] };

      log('ğŸ“¡ requestDevice ã‚’å‘¼ã³å‡ºã—ä¸­â€¦');
      device = await navigator.bluetooth.requestDevice(options);

      device.addEventListener('gattserverdisconnected', onDisconnected);

      log(`âœ… é¸æŠ: ${device.name || '(no name)'} [id=${device.id}]`);
      log('ğŸ”— æ¥ç¶šä¸­â€¦');
      server = await device.gatt.connect();
      log('âœ… æ¥ç¶šã—ã¾ã—ãŸ');

      const service = await server.getPrimaryService(serviceUuid);
      log(`ğŸ§© Service(${serviceUuid}) ã‚’å–å¾—`);

      characteristic = await service.getCharacteristic(charUuid);
      log(`ğŸ§¬ Characteristic(${charUuid}) ã‚’å–å¾—`);

      uiState(true);
    } catch (err) {
      log('âŒ ' + err);
      cleanup();
    }
  }

  function onDisconnected() {
    log('ğŸ”Œ ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
    cleanup();
  }

  function cleanup() {
    characteristic = null;
    server = null;
    if (device && device.gatt && device.gatt.connected) {
      try { device.gatt.disconnect(); } catch {}
    }
    device = null;
    uiState(false);
  }

  async function disconnect() {
    try {
      if (device && device.gatt.connected) device.gatt.disconnect();
    } catch (e) {
      log('âŒ ' + e);
    } finally {
      cleanup();
    }
  }

  async function readValue() {
    if (!characteristic) return;
    try {
      const value = await characteristic.readValue();
      // Battery Level(0x2A19) ã¯ 0â€“100 ã®1ãƒã‚¤ãƒˆ
      const bytes = new Uint8Array(value.buffer);
      log('ğŸ“¥ Read: [' + Array.from(bytes).join(', ') + ']');
    } catch (e) {
      log('âŒ Readå¤±æ•—: ' + e);
    }
  }

  async function writeValue() {
    if (!characteristic) return;
    try {
      // ãƒ‡ãƒ¢ç”¨: 1ãƒã‚¤ãƒˆ 0x01 ã‚’æ›¸ãè¾¼ã‚€
      // â€» å¤šãã®ãƒ‡ãƒã‚¤ã‚¹/ç‰¹æ€§ã¯æ›¸ãè¾¼ã¿ä¸å¯ã€‚å®Ÿæ©Ÿä»•æ§˜ã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
      const data = new Uint8Array([0x01]);
      await characteristic.writeValue(data);
      log('ğŸ“¤ Write: [0x01] é€ä¿¡ã—ã¾ã—ãŸ');
    } catch (e) {
      log('âŒ Writeå¤±æ•—: ' + e);
    }
  }

  async function startNotify() {
    if (!characteristic) return;
    try {
      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', (ev) => {
        const v = new Uint8Array(ev.target.value.buffer);
        log('ğŸ”” Notify: [' + Array.from(v).join(', ') + ']');
      });
      log('ğŸ”” é€šçŸ¥è³¼èª­ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
    } catch (e) {
      log('âŒ é€šçŸ¥é–‹å§‹å¤±æ•—: ' + e);
    }
  }

  async function stopNotify() {
    if (!characteristic) return;
    try {
      await characteristic.stopNotifications();
      log('ğŸ”• é€šçŸ¥è³¼èª­ã‚’åœæ­¢ã—ã¾ã—ãŸ');
    } catch (e) {
      log('âŒ é€šçŸ¥åœæ­¢å¤±æ•—: ' + e);
    }
  }

  // åˆæœŸUI
  uiState(false);

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  $('btnScan').addEventListener('click', async () => {
    if (!('bluetooth' in navigator)) {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Web Bluetooth ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome/Edge ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
      return;
    }
    await scanAndConnect();
  });

  $('btnDisconnect').addEventListener('click', disconnect);
  $('btnRead').addEventListener('click', readValue);
  $('btnWrite').addEventListener('click', writeValue);
  $('btnNotifyStart').addEventListener('click', startNotify);
  $('btnNotifyStop').addEventListener('click', stopNotify);
})();
</script>
</body>
</html>
